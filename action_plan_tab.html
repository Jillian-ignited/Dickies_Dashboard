<!-- ================================================================
     ACTION PLAN TAB - DYNAMIC VERSION
     Replace the existing Action Plan tab content with this HTML
     ================================================================ -->

<div id="actions" class="tab-content">
    <h2 class="section-title">‚ö° Action Plan: Data-Driven Priorities</h2>
    
    <!-- Strategic Overview -->
    <div class="insight-box" style="margin-bottom: 2rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);">
        <h3>üéØ Strategic Focus: [[TIER_AB_COUNT]] A+B SKUs Drive [[TIER_AB_SALES_PCT]] of Sales</h3>
        <p style="margin: 1rem 0;">
            The data reveals a clear opportunity structure: <strong>[[TIER_AB_COUNT]] SKUs (A+B items)</strong> generate <strong>[[TIER_AB_SALES_PCT]]</strong> of total sales, 
            while <strong>[[TIER_C_COUNT]] C-tier SKUs</strong> contribute only the remaining percentage. This Pareto distribution guides our action priorities below.
        </p>
        
        <div class="metric-grid" style="grid-template-columns: repeat(3, 1fr); margin: 1.5rem 0;">
            <div class="metric-card">
                <div class="metric-label">üåü A-Tier SKUs</div>
                <div class="metric-value status-good">[[TIER_A_COUNT]]</div>
                <div class="metric-subtitle">Top velocity drivers</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">‚≠ê B-Tier SKUs</div>
                <div class="metric-value">[[TIER_B_COUNT]]</div>
                <div class="metric-subtitle">Solid performers</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">‚ö†Ô∏è C-Tier SKUs</div>
                <div class="metric-value status-bad">[[TIER_C_COUNT]]</div>
                <div class="metric-subtitle">Phase-out candidates</div>
            </div>
        </div>
    </div>

    <!-- Action Items Summary -->
    <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 2rem;">
        <div class="metric-card" style="border-left: 4px solid #f44336;">
            <div class="metric-label">üî¥ High Priority Actions</div>
            <div class="metric-value" id="high-priority-count">-</div>
            <div class="metric-subtitle">Immediate attention required</div>
        </div>
        <div class="metric-card" style="border-left: 4px solid #ff9800;">
            <div class="metric-label">üü° Total Action Items</div>
            <div class="metric-value">[[ACTION_ITEMS_COUNT]]</div>
            <div class="metric-subtitle">Data-driven recommendations</div>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="action-filters" style="margin: 2rem 0;">
        <button class="filter-btn active" data-category="all" onclick="filterActions('all')">
            All (<span id="count-all">[[ACTION_ITEMS_COUNT]]</span>)
        </button>
        <button class="filter-btn" data-category="seasonal_markdown_risk" onclick="filterActions('seasonal_markdown_risk')">
            Seasonal Risk (<span id="count-seasonal">[[SEASONAL_RISK_COUNT]]</span>)
        </button>
        <button class="filter-btn" data-category="inventory_management" onclick="filterActions('inventory_management')">
            Inventory Management (<span id="count-inventory">-</span>)
        </button>
    </div>

    <!-- Action Cards Container -->
    <div id="action-cards-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
        <!-- JavaScript will populate this -->
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;">
            <p>Loading action items...</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">If this message persists, ensure action_items.json exists and html_updater_v5.py has been run.</p>
        </div>
    </div>
</div>

<!-- ================================================================
     ACTION PLAN JAVASCRIPT
     Add this script block after the existing skuData script
     ================================================================ -->

<script>
// Action Plan Tab Functions
(function() {
    'use strict';

    // Check if historicalData.actions exists
    if (typeof historicalData === 'undefined' || !historicalData.actions) {
        console.warn('No action items data found. Run html_updater_v5.py to inject data.');
        return;
    }

    const actions = historicalData.actions;

    // Calculate counts by category and priority
    function calculateCounts() {
        const counts = {
            all: actions.length,
            seasonal_markdown_risk: 0,
            inventory_management: 0,
            high_priority: 0,
            medium_priority: 0,
            low_priority: 0
        };

        actions.forEach(action => {
            const category = action.category || 'inventory_management';
            const priority = (action.priority || 'medium').toLowerCase();

            if (category === 'seasonal_markdown_risk') {
                counts.seasonal_markdown_risk++;
            } else {
                counts.inventory_management++;
            }

            if (priority === 'high') counts.high_priority++;
            else if (priority === 'medium') counts.medium_priority++;
            else if (priority === 'low') counts.low_priority++;
        });

        return counts;
    }

    // Update count displays
    function updateCounts() {
        const counts = calculateCounts();
        
        const countEls = {
            'count-all': counts.all,
            'count-seasonal': counts.seasonal_markdown_risk,
            'count-inventory': counts.inventory_management,
            'high-priority-count': counts.high_priority
        };

        for (const [id, value] of Object.entries(countEls)) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }
    }

    // Format category name for display
    function formatCategory(category) {
        if (category === 'seasonal_markdown_risk') return 'Seasonal Markdown Risk';
        if (category === 'inventory_management') return 'Inventory Management';
        return category;
    }

    // Get priority badge HTML
    function getPriorityBadge(priority) {
        const p = (priority || 'medium').toLowerCase();
        const colors = {
            high: '#f44336',
            medium: '#ff9800',
            low: '#4CAF50'
        };
        const color = colors[p] || colors.medium;
        return `<span class="priority-badge" style="background: ${color}; color: white; padding: 4px 12px; border-radius: 3px; font-size: 0.85rem; font-weight: bold;">${p.toUpperCase()}</span>`;
    }

    // Render action cards
    function renderActionCards(filterCategory = 'all') {
        const container = document.getElementById('action-cards-container');
        if (!container) return;

        // Filter actions
        let filtered = actions;
        if (filterCategory !== 'all') {
            filtered = actions.filter(a => (a.category || 'inventory_management') === filterCategory);
        }

        // Sort by priority (high > medium > low)
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        filtered.sort((a, b) => {
            const aPri = priorityOrder[(a.priority || 'medium').toLowerCase()] || 1;
            const bPri = priorityOrder[(b.priority || 'medium').toLowerCase()] || 1;
            return aPri - bPri;
        });

        // Generate HTML
        if (filtered.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;">
                    <p>No action items in this category.</p>
                </div>
            `;
            return;
        }

        const cardsHTML = filtered.map(action => {
            const priority = (action.priority || 'medium').toLowerCase();
            const category = action.category || 'inventory_management';
            const borderColor = priority === 'high' ? '#f44336' : (priority === 'medium' ? '#ff9800' : '#4CAF50');

            const targetId = action.action?.target_id || 'N/A';
            const targetDesc = action.action?.target_description || '';
            const recommendation = action.action?.recommendation || '';
            const rationale = action.action?.rationale || '';
            const impact = action.expected_impact?.metric || '';
            const timeframe = action.expected_impact?.timeframe_weeks || '';

            return `
                <div class="action-card" style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                    border-left: 5px solid ${borderColor};
                    border-radius: 8px;
                    padding: 1.5rem;
                    transition: transform 0.2s, box-shadow 0.2s;
                ">
                    <div class="action-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        ${getPriorityBadge(priority)}
                        <span class="category-tag" style="background: #333; padding: 4px 12px; border-radius: 3px; font-size: 0.85rem; color: #aaa;">
                            ${formatCategory(category)}
                        </span>
                    </div>
                    
                    <div class="action-body">
                        <h4 style="color: #4CAF50; margin-bottom: 0.75rem; font-size: 1.05rem;">
                            ${targetId}${targetDesc ? ' - ' + targetDesc : ''}
                        </h4>
                        
                        <p style="color: #fff; margin: 0.75rem 0; font-weight: 500;">
                            <strong>Action:</strong> ${recommendation}
                        </p>
                        
                        ${rationale ? `<p style="color: #aaa; font-size: 0.9rem; margin: 0.75rem 0;">${rationale}</p>` : ''}
                    </div>
                    
                    <div class="action-footer" style="
                        display: flex;
                        justify-content: space-between;
                        margin-top: 1rem;
                        padding-top: 1rem;
                        border-top: 1px solid #444;
                        font-size: 0.85rem;
                        color: #888;
                    ">
                        ${impact ? `<span>Impact: ${impact}</span>` : '<span></span>'}
                        ${timeframe ? `<span>Timeline: ${timeframe} weeks</span>` : '<span></span>'}
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = cardsHTML;

        // Add hover effect
        container.querySelectorAll('.action-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });
    }

    // Filter function (global scope for onclick handlers)
    window.filterActions = function(category) {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.category === category) {
                btn.classList.add('active');
            }
        });

        // Render filtered cards
        renderActionCards(category);
    };

    // Initialize on page load
    updateCounts();
    renderActionCards();

})();
</script>

<!-- ================================================================
     ACTION PLAN STYLES
     Add this to your existing <style> block
     ================================================================ -->

<style>
.action-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 10px 20px;
    border: 2px solid #444;
    background: transparent;
    color: #ddd;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.95rem;
}

.filter-btn:hover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.filter-btn.active {
    background: #4CAF50;
    border-color: #4CAF50;
    color: #000;
    font-weight: bold;
}

#action-cards-container {
    min-height: 200px;
}

.action-card {
    cursor: default;
}

@media (max-width: 768px) {
    #action-cards-container {
        grid-template-columns: 1fr !important;
    }
}
</style>
